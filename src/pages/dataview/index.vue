<template>
  <div>
    <Transition appear enter-active-class="animate__animated animate__fadeInLeft"
      leave-active-class="animate__animated animate__fadeOutRight">
      <el-breadcrumb separator="/" class="size">
        <el-breadcrumb-item>数据集</el-breadcrumb-item>
      </el-breadcrumb>
    </Transition>
    <el-card class="card-style" shadow="hover" :body-style="{ padding: '10px' }" style="height: calc(100vh - 170px)">
      <el-row>
        <el-select class="size" v-model="tag" placeholder="请选择示范点" style="width: 200px" @change="selectChange" clearable
          @clear="fixMap()" size="small">
          <el-option v-for="item in options" :key="item.index" :label="item.name" :value="item.tag">
          </el-option>
        </el-select>
        <el-button @click="changeSize()" size="small" type="primary" style="margin-left:10px"
          v-if="!showDoubleMap">结果对比</el-button>
        <el-button @click="changeSize()" size="small" type="primary" style="margin-left:10px"
          v-if="showDoubleMap">还原</el-button>
      </el-row>
      <el-button @click="create()" size="small" v-if="tag" style="
                                                                                                                position: fixed;
                                                                                                                bottom: 260px;
                                                                                                                right: 31px;
                                                                                                                z-index: 9999999;
                                                                                                                font-size: 16px;
                                                                                                                padding: 6px;
                                                                                                              "
        icon="el-icon-circle-plus-outline"></el-button>

      <!-- <el-button @click="full()" size="small" v-if="tag" style="
          position: fixed;
          bottom: 260px;
          right: 31px;
          z-index: 9999999;
          font-size: 16px;
          padding: 6px;
        " icon="el-icon-full-screen"></el-button> -->
      <el-button @click="addThreeD()" size="small" style="
                                                                                                                position: fixed;
                                                                                                                bottom: 185px;
                                                                                                                right: 31px;
                                                                                                                z-index: 9999999;
                                                                                                                font-size: 14px;
                                                                                                                padding: 5px;
                                                                                                              "
        v-if="!is3D">3D</el-button>
      <el-button @click="addTwoD()" size="small" style="
                                                                                                                position: fixed;
                                                                                                                bottom: 185px;
                                                                                                                right: 31px;
                                                                                                                z-index: 9999999;
                                                                                                                font-size: 14px;
                                                                                                                padding: 5px;
                                                                                                              "
        v-if="is3D">2D</el-button>
      <el-button @click="fixMap()" size="small" style="
                                                                                                                position: fixed;
                                                                                                                bottom: 222px;
                                                                                                                right: 31px;
                                                                                                                z-index: 9999999;
                                                                                                                font-size: 16px;
                                                                                                                padding: 6px;
                                                                                                              "
        icon="el-icon-view" v-if="!isFixed"></el-button>
      <!-- <el-button
        @click="initMap(3)"
        size="small"
        style="
          position: fixed;
          bottom: 260px;
          right: 31px;
          z-index: 9999999;
          font-size: 16px;
          padding: 6px;
        "
        v-if="!isFixed"
        icon="el-icon-refresh-left"
      ></el-button> -->

      <div id="map" style="float:right"></div>
      <div id="resultMap" style="float:right">
      </div>
      <el-card v-if="showDoubleMap && selectedTag == '孟买'"
        style="width: 100px;height: 100px;position: fixed;top: 168px;left: 230px;z-index: 9;"
        :body-style="{ padding: '10px' }">我是孟买图例</el-card>
      <el-card v-if="showDoubleMap && selectedTag == '瓜德尔港'"
        style="width: 100px;height: 100px;position: fixed;top: 168px;left: 230px;z-index: 9;"
        :body-style="{ padding: '10px' }">我是瓜德尔港图例</el-card>
      <el-card v-if="showDoubleMap && selectedTag == '孟加拉国'"
        style="width: 100px;height: 100px;position: fixed;top: 168px;left: 230px;z-index: 9;"
        :body-style="{ padding: '10px' }">我是孟加拉国图例</el-card>
      <el-card v-if="showDoubleMap && selectedTag == '哈萨克斯坦'"
        style="width: 100px;height: 100px;position: fixed;top: 168px;left: 230px;z-index: 9;"
        :body-style="{ padding: '10px' }">我是哈萨克斯坦图例</el-card>
      <el-card v-if="showDoubleMap && selectedTag == '缅甸'"
        style="width: 100px;height: 100px;position: fixed;top: 168px;left: 230px;z-index: 9;"
        :body-style="{ padding: '10px' }">我是缅甸图例</el-card>

      <div id="fullScreenMap" v-show="isFullScreen" style="height: 100%; width: 100%">
        <dv-border-box-11 :title="selectedTag" class="zIndex">
          <el-row style="height: 50px; padding-top: 43px">
            <el-col :span="9"><dv-decoration-1 style="width: 100%; height: 50px"
                :color="['#7589CD', '#7589CD']" /></el-col>
            <el-col :span="6"><dv-decoration-5 style="width: 100%; height: 50px"
                :color="['#7589CD', '#7589CD']" /></el-col>
            <el-col :span="9"><dv-decoration-1 style="width: 100%; height: 50px"
                :color="['#7589CD', '#7589CD']" /></el-col>
          </el-row>
          <el-row style="margin-left: 40px; margin-right: 40px">
            <el-col :span="6"><dv-scroll-board :config="config1" style="width: 100%; height: 180px"
                :color="['#7589CD', '#7589CD']" /></el-col>
            <el-col :span="6" :offset="12"><dv-decoration-6 style="width: 80%; height: 50px; padding-right: 200px"
                :color="['#7589CD', '#7589CD']" /></el-col>
          </el-row>
          <!-- <el-row
            style="margin-left: 40px; margin-right: 40px; padding-top: 40px"
          >
            <el-col :span="6"
              ><dv-decoration-7
                style="
                  width: 100%;
                  height: 50px;
                  font-size: 21px;
                  font-weight: 1000;
                  color: white;
                "
                :color="['#7589CD']"
                >模型运行次数</dv-decoration-7
              ></el-col
            >
            <el-col :span="6" :offset="12"></el-col>
          </el-row>
          <el-row style="margin-left: 40px; margin-right: 40px">
            <el-col :span="6"
              ><dv-capsule-chart
                :config="config2"
                style="width: 400px; height: 200px; font-size: 16px"
                :color="['#7589CD', '#7589CD']"
            /></el-col>
            <el-col :span="6" :offset="12"></el-col>
          </el-row> -->
          <el-row style="margin-left: 30px; margin-right: 40px">
            <el-col :span="6"><dv-decoration-8 style="position: fixed; width: 46%; height: 50px; bottom: 10px"
                :color="['#7589CD', '#7589CD']" /></el-col>
            <el-col :span="6" :offset="12"><dv-decoration-8 :reverse="true"
                style="position: fixed; width: 46%; height: 50px; bottom: 10px"
                :color="['#7589CD', '#7589CD']" /></el-col>
          </el-row>
        </dv-border-box-11>
      </div>

    </el-card>
  </div>
</template>

<script>
import { mapState } from "vuex";
import { addMengmaiLayer } from "./mengmai";
import { addGuadaerLayer } from "./guadaer";
import { mengjialaguo_after, mengjialaguo_before } from "./mengjialaguo";
// import mapboxgl from "mapbox-gl";
import MapboxLanguage from "@mapbox/mapbox-gl-language";
import { } from "@/api";

export default {
  name: "DataView",
  data() {
    return {
      mapState: [
        ['http://202.195.239.146:92/geoserver/guadaer/wms?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&WIDTH=256&HEIGHT=256&layers=guadaer:guadaer1',
          'http://202.195.239.146:92/geoserver/guadaer/wms?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&WIDTH=256&HEIGHT=256&layers=guadaer:guadaer2',
          'http://202.195.239.146:92/geoserver/guadaer/wms?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&WIDTH=256&HEIGHT=256&layers=guadaer:guadaer3',
          'http://202.195.239.146:92/geoserver/guadaer/wms?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&WIDTH=256&HEIGHT=256&layers=guadaer:guadaer4',
          'http://202.195.239.146:92/geoserver/guadaer/wms?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&WIDTH=256&HEIGHT=256&layers=guadaer:guadaer5',
        ],
        ['http://202.195.239.146:92/geoserver/mengmai/wms?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&WIDTH=256&HEIGHT=256&layers=mengmai:mengmai1',
          'http://202.195.239.146:92/geoserver/mengmai/wms?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&WIDTH=256&HEIGHT=256&layers=mengmai:mengmai2',
          'http://202.195.239.146:92/geoserver/mengmai/wms?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&WIDTH=256&HEIGHT=256&layers=mengmai:mengmai3',
          'http://202.195.239.146:92/geoserver/mengmai/wms?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&WIDTH=256&HEIGHT=256&layers=mengmai:mengmai4',
          'http://202.195.239.146:92/geoserver/mengmai/wms?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&WIDTH=256&HEIGHT=256&layers=mengmai:mengmai5',
          'http://202.195.239.146:92/geoserver/mengmai/wms?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&WIDTH=256&HEIGHT=256&layers=mengmai:mengmai6',
          'http://202.195.239.146:92/geoserver/mengmai/wms?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&WIDTH=256&HEIGHT=256&layers=mengmai:mengmai7',
          'http://202.195.239.146:92/geoserver/mengmai/wms?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&WIDTH=256&HEIGHT=256&layers=mengmai:mengmai8',
          'http://202.195.239.146:92/geoserver/mengmai/wms?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&WIDTH=256&HEIGHT=256&layers=mengmai:mengmai9',
          'http://202.195.239.146:92/geoserver/mengmai/wms?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&WIDTH=256&HEIGHT=256&layers=mengmai:mengmai10',
        ],
      ],
      map: null,
      fullMap: null,
      resultMap: null,
      tag: null,
      selectedTag: null,
      is3D: false,
      isFixed: true,
      isFullScreen: false,
      templateId: null,
      showDoubleMap: false,
      currentImage: 0,
      frameCount: 5,
      options: [
        {
          index: 0, name: "孟买", tag: [72.880127, 19.075847], zoom: 15, templateId: 39, message: `<div style="height:100%;width:100%;">
              <div style="text-align:center"><h1>孟买</h1></div>
              <div>
                <h5 style="font-size:16px"><span style="font-weight:800;">简介:</span>孟买, 是印度西部滨海城市，印度第一大港口，棉纺织业中心，马哈拉施特拉邦首府。孟买是印度重要的贸易中心和港口城市。</h5>
              </div>
              </div>`},

        {
          index: 1,
          name: "瓜德尔港",
          tag: [62.323615, 25.119452],
          zoom: 15,
          templateId: 32,
          message: `<div style="height:100%;width:100%;">
              <div style="text-align:center"><h1>瓜德尔港</h1></div>
              <div>
                <h5 style="font-size:16px"><span style="font-weight:800;">简介:</span>瓜德尔港是巴基斯坦的重要港口。瓜德尔港位于巴基斯坦俾路支省西南部瓜德尔城南部，为深水良港。中国政府应穆沙拉夫总统的请求为该港口建设提供资金和技术援助。该港口于2002年3月开工兴建，2015年2月瓜德尔港基本竣工，预计4月中旬全面投入运营。中国部分石油的运输路程将缩短85%。</h5>
              </div>
              </div>`
        },
        {
          index: 2,
          name: "缅甸",
          tag: [
            96.50560601192916,
            21.159081597411173
          ],
          zoom: 15,
          templateId: 38,
          message: `<div style="height:100%;width:100%;">
              <div style="text-align:center"><h1>缅甸</h1></div>
              <div>
                <h5 style="font-size:16px"><span style="font-weight:800;">简介:</span>缅甸联邦共和国（The Republic of the Union of Myanmar）。面积：676578平方公里。人口：5458万（2020年4月），共有135个民族，主要有缅族、克伦族、掸族、克钦族、钦族、克耶族、孟族和若开族等，缅族约占总人口的65%。</h5>
              </div>
              </div>`
        },
        {
          index: 3,
          name: "孟加拉国",
          tag: [
            89.91287977937156, 23.64362166893602
          ],
          zoom: 11,
          templateId: 34,
          message: `<div style="height:100%;width:100%;">
              <div style="text-align:center"><h1>孟加拉国</h1></div>
              <div>
                <h5 style="font-size:16px"><span style="font-weight:800;">简介:</span>孟加拉国位于南亚次大陆东北部的恒河和布拉马普特拉河冲积而成的三角洲上。东、西、北三面与印度毗邻，东南部与缅甸接壤，南部濒临孟加拉湾。海岸线长550公里。全境85%的地区为平原，东南部和东北部为丘陵地带，国土大部分地区海拔低于12米。</h5>
              </div>
              </div>`
        },
        {
          index: 4,
          name: "哈萨克斯坦",
          tag: [
            67.30603532421415,
            48.192331189685405
          ],
          zoom: 15,
          templateId: 36,
          message: `<div style="height:100%;width:100%;">
              <div style="text-align:center"><h1>哈萨克斯坦</h1></div>
              <div>
                <h5 style="font-size:16px"><span style="font-weight:800;">简介:</span>哈萨克斯坦共和国位于中亚北部，与我国的新疆维吾尔自治区接壤。哈萨克斯坦是一个横跨亚洲、欧洲两大陆的国家，其在乌拉尔河以西的一小部分领土位于欧洲。</h5>
              </div>
              </div>`
        },
      ],
      config1: {
        header: ["序号", "经纬度"],
        data: [
          ["孟买", "[72.830127, 18.975847]"],
          ["瓜德尔港", "[62.323615, 25.103452]"],
          ["示范点3", "示范点3"],
          ["示范点4", "示范点4"],
          ["示范点5", "示范点5"],
        ],
        index: true,
        columnWidth: [50],
        align: ["center"],
        rowNum: 4,
      },
      config2: {
        data: [
          {
            name: "示范点1",
            value: 55,
          },
          {
            name: "示范点2",
            value: 10,
          },
          {
            name: "示范点3",
            value: 78,
          },
          {
            name: "示范点4",
            value: 66,
          },
          {
            name: "示范点5",
            value: 80,
          },
        ],
      },
    };
  },
  computed: {},
  methods: {
    changeSize() {
      let timer

      if (!this.showDoubleMap) {
        this.showDoubleMap = true;
        document.getElementById("map").style.width = (document.body.clientWidth - 200 - 46) / 2 + 'px'
        document.getElementById("resultMap").style.width = (document.body.clientWidth - 200 - 46) / 2 + 'px'
        document.getElementById("resultMap").style.top = 10 + 'px'
        this.initMap(3)
        let _this = this;
        // timer = setInterval(() => {
        //   _this.currentImage = (_this.currentImage + 1) % _this.frameCount;
        //   _this.resultMap.getSource('radar').updateImage({ url: _this.getPath() });
        // }, 500);
      } else {
        document.getElementById("map").style.width = (document.body.clientWidth - 200 - 30) + 'px'
        document.getElementById("resultMap").style.top = 200 + 'px'
        this.showDoubleMap = false;
        this.initMap(3)
        clearInterval(timer)
      }

    },
    create() {
      this.$store.dispatch("Template/getJobTemplate", { templateId: this.templateId })
      this.$store.dispatch("Template/getTaskTemplate", { templateId: this.templateId })
      this.$router.push({
        name: "standardjob",
        query: { templateId: this.templateId }
      })
    },
    addThreeD() {
      this.map.addSource("mapbox-dem", {
        type: "raster-dem",
        url: "mapbox://mapbox.mapbox-terrain-dem-v1",
        tileSize: 512,
        maxzoom: 14,
      });
      this.map.setTerrain({ source: "mapbox-dem", exaggeration: 1.5 });
      this.is3D = true;
      this.isFixed = false;
    },
    addTwoD() {
      this.map.setTerrain();
      this.map.removeSource("mapbox-dem");
      this.is3D = false;
      this.isFixed = false;
    },
    full() {
      this.isFullScreen = true;
      this.launchFullscreen(document.getElementById("fullScreenMap"));
    },
    launchFullscreen(element) {
      if (element.requestFullscreen) {
        element.requestFullscreen();
      } else if (element.mozRequestFullScreen) {
        element.mozRequestFullScreen();
      } else if (element.msRequestFullscreen) {
        element.msRequestFullscreen();
      } else if (element.webkitRequestFullscreen) {
        element.webkitRequestFullScreen();
      }
    },
    // 判断全屏
    checkFull() {
      //判断浏览器是否处于全屏状态 （需要考虑兼容问题）
      //火狐浏览器
      var isFull =
        document.mozFullScreen ||
        document.fullScreen ||
        //谷歌浏览器及Webkit内核浏览器
        document.webkitIsFullScreen ||
        document.webkitRequestFullScreen ||
        document.mozRequestFullScreen ||
        document.msFullscreenEnabled;
      if (isFull === undefined) {
        isFull = false;
      }
      return isFull;
    },
    selectChange(value) {
      this.fixMap();
      this.jumpTo(value);
      this.initFullScreenMap(value);
      let z;
      this.options.forEach((item) => {
        if (item.tag == value) {
          z = item;
        }
      });
      this.templateId = z.templateId
    },
    jumpTo(tag) {
      let z;
      this.options.forEach((item) => {
        if (item.tag == tag) {
          z = item;
        }
      });
      console.log(z);
      this.selectedTag = z.name;
      this.map.flyTo({
        center: tag,
        zoom: z.zoom,
      });
      this.tag = tag;
      this.isFixed = false;
    },
    fixMap() {
      this.map.flyTo({
        zoom: 3,
        center: [120, 40],
      });
      this.tag = null;
    },
    getPath() {
      return `https://docs.mapbox.com/mapbox-gl-js/assets/radar` + this.currentImage + `.gif`;
    },
    initMap(zoom) {

      this.map = null;
      let mapDiv = document.getElementById('map')
      if (mapDiv.childNodes.length != 0) {
        for (let i = 0; i < mapDiv.childNodes.length; i++) {
          mapDiv.removeChild(mapDiv.childNodes[i])
        }
      }
      this.resultMap = null;
      let resultMapDiv = document.getElementById('resultMap')
      if (resultMapDiv.childNodes.length != 0) {
        for (let i = 0; i < resultMapDiv.childNodes.length; i++) {
          resultMapDiv.removeChild(resultMapDiv.childNodes[i])
        }
      }

      // mapboxgl.accessToken =
      //   "pk.eyJ1IjoicGxheS1pc2FhYyIsImEiOiJjazU0cDkzbWowamd2M2dtemd4bW9mbzRhIn0.cxD4Fw3ZPB_taMkyUSFENA";
      mapboxgl.accessToken =
        "pk.eyJ1IjoibGF3aW5iZWUiLCJhIjoiY2w4OWpoNW5kMDBrdzNwbzNtcTgxaDl1YiJ9.xjTaNpwhQeBpbIFrQaXsKw";

      const map = new mapboxgl.Map({
        container: "map", // container ID
        // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
        style: "mapbox://styles/mapbox/satellite-streets-v11",
        // style: "mapbox://styles/mapbox/dark-v10",
        // style: "mapbox://styles/mapbox/streets-v11",
        zoom: zoom,
        center: [
          77.08685480625758,
          35.532881863509374
        ],
        // projection: "globe",
        antialias: false,
        attributionControl: false,
      });
      const resultMap = new mapboxgl.Map({
        container: "resultMap", // container ID
        // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
        // style: "mapbox://styles/mapbox/satellite-streets-v11",
        style: "mapbox://styles/lawinbee/clg191r9o004o01mmhyrr4hfs",
        // style: "mapbox://styles/mapbox/streets-v11",
        zoom: zoom,
        center: [120, 40],
        // projection: "globe",
        antialias: false,
        attributionControl: false,
      });
      map.on("click", (e) => {
        const { lng, lat } = e.lngLat;
        console.log(lng, lat);
      });
      map.on("style.load", () => {
        map.setFog({}); // Set the default atmosphere style
      });
      resultMap.on("style.load", () => {
        resultMap.setFog({}); // Set the default atmosphere style
      });
      map.doubleClickZoom.disable();
      resultMap.doubleClickZoom.disable();
      // 设置语言
      var language = new MapboxLanguage({ defaultLanguage: "zh-Hans" });
      var language2 = new MapboxLanguage({ defaultLanguage: "zh-Hans" });
      map.addControl(language);
      resultMap.addControl(language2);
      // 地图导航
      var nav = new mapboxgl.NavigationControl();
      map.addControl(nav, "bottom-right");
      // 比例尺
      var scale = new mapboxgl.ScaleControl({
        maxWidth: 100,
        unit: "imperial",
      });
      map.addControl(scale);
      scale.setUnit("metric");
      let _this = this;
      // resultMap.on('load', () => {
      //   resultMap.addSource('radar', {
      //     'type': 'image',
      //     'url': _this.getPath(),
      //     'coordinates': [
      //       [62.314543049432984, 25.115354530413],
      //       [62.314543049432984, 25.095380319320554],
      //       [62.3365095788937, 25.09550465022575],
      //       [62.336418051687644, 25.115271656610616]
      //     ]
      //   });
      //   resultMap.addLayer({
      //     id: 'radar-layer',
      //     'type': 'raster',
      //     'source': 'radar',
      //     'paint': {
      //       'raster-fade-duration': 0
      //     }
      //   });
      // });
      addMengmaiLayer(resultMap);
      addGuadaerLayer(resultMap);
      mengjialaguo_after(resultMap);
      mengjialaguo_before(map)
      for (let i = 0; i < this.options.length; i++) {
        let marker = new mapboxgl.Marker({
          color: "#BB271A",
          clickTolerance: 10,
          draggable: true,
        })
          .setDraggable(false)
          .setLngLat(this.options[i].tag)
          .setPopup(
            new mapboxgl.Popup().setHTML(
              this.options[i].message
            )
          )
          .addTo(map);

      }
      for (let i = 0; i < this.options.length; i++) {
        let marker = new mapboxgl.Marker({
          color: "#5995FC",
          clickTolerance: 10,
          draggable: true,
        })
          .setDraggable(false)
          .setLngLat(this.options[i].tag)
          .setPopup(
            new mapboxgl.Popup().setHTML(
              this.options[i].message
            )
          )
          .addTo(resultMap);

      }

      for (let i = 0; i < this.mapState.length; i++) {
        for (let j = 0; j < this.mapState[i].length; j++) {
          console.log(_this.mapState[i][j]);
          map.on('load', () => {
            map.addSource(String(i + 'a' + j), {
              'type': 'raster',
              'tiles': [
                _this.mapState[i][j]
              ],
              'tileSize': 256
            }); map.addLayer({
              'id': String(i + 'a' + j),
              'type': 'raster',
              'source': String(i + 'a' + j), // reference the data source
              'paint': {
                'raster-opacity': 1
              }
            })

          })
        }
      }
      // 拖拽
      // resultMap.on("drag", function () {
      //   let resultMap_x = resultMap.getCenter().lng;
      //   let resultMap_y = resultMap.getCenter().lat;
      //   map.setCenter([resultMap_x, resultMap_y]);
      // });
      map.on("drag", function () {
        let map_x = map.getCenter().lng;
        let map_y = map.getCenter().lat;
        resultMap.setCenter([map_x, map_y]);
      });

      //   放大缩小
      // resultMap.on("zoom", function () {
      //   let resultMap_zoom = resultMap.getZoom();
      //   map.setZoom(resultMap_zoom);
      // });
      map.on("zoom", function () {
        let map_zoom = map.getZoom();
        let map_x = map.getCenter().lng;
        let map_y = map.getCenter().lat;
        resultMap.setCenter([map_x, map_y]);
        resultMap.setZoom(map_zoom);
      });

      // // 倾斜
      // resultMap.on("pitch", function () {
      //   let resultMap_pitch = resultMap.getPitch();
      //   map.setPitch(resultMap_pitch);
      // });
      map.on("pitch", function () {
        let map_pitch = map.getPitch();
        let map_x = map.getCenter().lng;
        let map_y = map.getCenter().lat;
        resultMap.setCenter([map_x, map_y]);
        resultMap.setPitch(map_pitch);
      });

      // // 旋转
      map.on("rotate", function () {
        let map_bear = map.getBearing();
        resultMap.setBearing(map_bear);
      });
      // resultMap.on("rotate", function () {
      //   let resultMap_bear = resultMap.getBearing();
      //   map.setBearing(resultMap_bear);
      // });


      this.map = map;
      this.resultMap = resultMap;
      this.map.on("dblclick", (e) => {
        _this.flyToMarker(e);
      });
      this.isFixed = true;
      this.is3D = false;
      this.tag = null;
    },
    initFullScreenMap(index) {
      let z = {};
      this.options.forEach((item) => {
        if (item.tag == index) {
          z = item;
        }
      });
      if (!z.zoom) {
        z.zoom = 2;
      }
      mapboxgl.accessToken =
        "pk.eyJ1IjoibGF3aW5iZWUiLCJhIjoiY2w4OWpoNW5kMDBrdzNwbzNtcTgxaDl1YiJ9.xjTaNpwhQeBpbIFrQaXsKw";

      const map = new mapboxgl.Map({
        container: "fullScreenMap", // container ID
        // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
        // style: "mapbox://styles/mapbox/satellite-streets-v11",
        style: "mapbox://styles/mapbox/dark-v10",
        // style: "mapbox://styles/mapbox/streets-v11",
        zoom: z.zoom,
        center: index,
        // projection: "globe",
        antialias: false,
        attributionControl: false,
      });
      // 设置语言
      var language = new MapboxLanguage({ defaultLanguage: "zh-Hans" });
      map.addControl(language);
      map.on("style.load", () => {
        map.setFog({}); // Set the default atmosphere style
      });
      for (let i = 0; i < this.options.length; i++) {
        new mapboxgl.Marker({
          color: "#5995FC",
          clickTolerance: 10,
          draggable: true,
        })
          .setDraggable(false)
          .setLngLat(this.options[i].tag)
          .setPopup(
            new mapboxgl.Popup().setHTML(
              this.options[i].message
            )
          )
          .addTo(map);
      }
      this.fullMap = map;
    },
    flyToMarker(e) {
      let flag = true
      for (let i = 0; i < this.options.length; i++) {
        if (this.options[i].tag[0] - 2 <= e.lngLat.lng &&
          e.lngLat.lng <= this.options[i].tag[0] + 2 &&
          this.options[i].tag[1] - 2 <= e.lngLat.lat &&
          e.lngLat.lat <= this.options[i].tag[1] + 2) {
          this.isFixed = false;
          this.tag = this.options[i].name;

          this.map.flyTo({
            center: this.options[i].tag,
            zoom: this.options[i].zoom,
          });
          // this.fullMap.flyTo({
          //   center: this.options[i].tag,
          //   zoom: this.options[i].zoom,
          // });
          this.selectedTag = this.options[i].name;
          this.templateId = this.options[i].templateId
          flag = false
        }

      }
      if (flag) {
        this.isFixed = false;
        this.map.flyTo({
          center: e.lngLat,
          zoom: 10,
        });
      }
    },
  },
  mounted() {
    this.initMap(3);
    // this.initFullScreenMap([120, 40]);
    document.getElementById("resultMap").style.top = 200 + 'px'
  },

  created() {
    window.onresize = () => {
      if (!this.checkFull()) {
        // 退出全屏后要执行的动作
        console.log("退出全屏");
        this.isFullScreen = false;
      }
    };
  },
};
</script>

<style scoped>
@import "mapbox-gl/dist/mapbox-gl.css";

.zIndex {
  z-index: 9;
}

.el-breadcrumb {
  margin-top: 10px;
  margin-left: 10px;
}

.card-style {
  margin: 10px;
  height: 650px;
}

.el-row {
  margin-top: 10px;
  width: 100%;
}

.el-select {
  width: 340px;
}

.el-form {
  align-items: flex-start;
}

.h3 {
  margin-top: 10px;
  margin-left: 10px;
}

.size {
  font-size: 16px;
}

.el-form-item>>>.el-form-item__error {
  padding: 0px;
}

.dialogClass .el-dialog__body {
  padding: 0px;
  margin: 0px;
  overflow-y: auto;
}

#map {
  position: relative;
  border-radius: 5px;
  height: calc(100vh - 240px);
  width: calc(100%);
  top: 10px;
}

/* 隐藏mapbox商标 */
#map>>>.mapboxgl-ctrl-logo {
  display: none !important;
}

#resultMap {
  position: relative;
  border-radius: 5px;
  height: calc(100vh - 240px);
  width: calc((100% - 200px - 46px) / 2);
  top: 10px;
}

/* 隐藏mapbox商标 */
#resultMap>>>.mapboxgl-ctrl-logo {
  display: none !important;
}

#fullScreenMap>>>.mapboxgl-ctrl-logo {
  display: none !important;
}
</style>
